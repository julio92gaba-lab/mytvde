<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>My TVDE - Gest√£o Profissional</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    /* BASE */
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Inter', sans-serif; background-color: #000; color: #fff; display: flex; justify-content: center; overflow-x: hidden; }
    .app-container { width: 100%; max-width: 415px; min-height: 100vh; background-color: #393838; position: relative; padding-top: 65px; padding-bottom: 100px; }
    
    header { 
      position: fixed; top: 0; width: 100%; max-width: 415px; height: 65px; 
      background-color: #000; background-image: url("https://iili.io/f6N6XVe.jpg"); 
      background-repeat: no-repeat; background-position: center center; background-size: contain; z-index: 1000; 
    }
    .header-subtext { text-align: center; color: #afafaf; font-size: 10px; margin-top: 48px; font-weight: 300; letter-spacing: 0.5px; }

    /* TRANSI√á√ïES */
    .tab-content { display: none; padding: 0 12px; animation: slideUpFade 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
    .tab-content.active { display: block; }
    @keyframes slideUpFade { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    /* CARDS */
    .card { width: 100%; background-color: #000; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #222; }
    .section-title { font-size: 18px; font-weight: 600; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
    
    .nav-data-container { display: flex; align-items: center; justify-content: space-between; margin: 10px 0 15px; }
    .nav-arrow { color: #00bf63; font-weight: bold; font-size: 22px; cursor: pointer; padding: 0 15px; }
    .nav-arrow.disabled { opacity: 0.2; pointer-events: none; }
    .section-date { font-size: 13px; font-weight: bold; text-align: center; flex: 1; }

    /* TABELAS */
    .table-container { width: 100%; border-collapse: collapse; font-size: 11px; color: white; margin-top: 5px; }
    .table-container th, .table-container td { border: 1px solid #333; padding: 8px 5px; text-align: center; }
    .table-container th { background: #1a1a1a; color: #00bf63; }
    .resumo-line { border-radius: 4px; padding: 10px; display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 13px; font-weight: 500; }

    /* DOCK iOS */
    .dock-container {
      position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%);
      width: 92%; max-width: 380px; height: 65px;
      background: rgba(30, 30, 30, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 25px;
      display: flex; justify-content: space-around; align-items: center; z-index: 2000;
    }
    .dock-item { display: flex; flex-direction: column; align-items: center; color: #888; cursor: pointer; position: relative; transition: 0.3s; }
    .dock-item.active { color: #00bf63; transform: translateY(-3px); }
    .dock-item span { font-size: 10px; font-weight: 600; margin-top: 4px; }
    .dock-item.active::after { content: ''; position: absolute; bottom: -8px; width: 4px; height: 4px; background: #00bf63; border-radius: 50%; }

    /* BOT√ÉO EXCEL */
    .btn-excel { width:100%; padding:12px; border-radius:8px; border:none; background:#1d6f42; color:white; font-weight:bold; font-size:14px; cursor:pointer; margin-bottom:12px; display:flex; align-items:center; justify-content:center; gap:10px; }

    /* INPUTS / MODAL */
    .km-input { width: 100%; padding: 8px; border-radius: 5px; border: 1px solid #444; background: #111; color: #fff; text-align: center; font-size: 14px; }
    .btn-add { background: #00bf63; color: #fff; border: none; padding: 6px 12px; border-radius: 5px; font-size: 11px; cursor: pointer; font-weight: bold; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 3000; justify-content: center; align-items: center; }
    .modal-content { background: #222; padding: 20px; border-radius: 15px; width: 85%; max-width: 350px; }
    .modal-input, .modal-select { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; background: #333; color: #fff; border: 1px solid #444; }
    .reembolso-container { display: flex; gap: 10px; margin-bottom: 15px; }
    .reembolso-btn { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #444; background: #333; color: #fff; cursor: pointer; font-size: 12px; text-align: center; }
    .reembolso-btn.active { background: #00bf63; border-color: #00bf63; font-weight: bold; }
  </style>
</head>
<body>

  <header><div class="header-subtext">Gest√£o Financeira e Operacional</div></header>

  <div class="app-container">
    <section id="tab-dia" class="tab-content active">
      <div class="nav-data-container">
        <span class="nav-arrow" onclick="mudarData(-1)">&#10094;</span>
        <div id="label-dia" class="section-date"></div>
        <span class="nav-arrow" id="seta-dia-next" onclick="mudarData(1)">&#10095;</span>
      </div>
      <div class="card">
        <div class="section-title">Rendimentos <span id="dia-total-bruto" style="color:#00bf63;">‚Ç¨ 0,00</span></div>
        <div style="display:flex; gap:10px;">
          <div id="uber-slot" style="flex:1"></div>
          <div id="bolt-slot" style="flex:1"></div>
        </div>
      </div>
      <div class="card">
        <div class="section-title">Despesas <button class="btn-add" onclick="abrirModalDespesa()">+ Adicionar</button></div>
        <div id="lista-despesas-dia"></div>
      </div>
      <div class="card">
        <div class="section-title">Quilometragem</div>
        <div style="display:flex; gap:10px; align-items:center;">
          <input type="number" id="km-inicio" class="km-input" placeholder="In√≠cio" onchange="salvarDadosDia()">
          <input type="number" id="km-fim" class="km-input" placeholder="Fim" onchange="salvarDadosDia()">
        </div>
        <div id="km-total-dia" style="text-align:center; margin-top:10px; font-weight:bold; color:#00bf63;">0 km</div>
      </div>
    </section>

    <section id="tab-semana" class="tab-content">
      <div class="nav-data-container">
        <span class="nav-arrow" onclick="mudarData(-7)">&#10094;</span>
        <div id="label-semana" class="section-date"></div>
        <span class="nav-arrow" id="seta-semana-next" onclick="mudarData(7)">&#10095;</span>
      </div>
      <div class="card">
        <div class="section-title">Resumo Financeiro <span id="semana-vv-status" onclick="abrirModalVV()" style="font-size:10px; text-decoration:underline; cursor:pointer;">Via Verde</span></div>
        <div class="resumo-line" style="background:#00bf63; color:#000;" id="semana-liquido-row">
          <span>L√≠quido a receber:</span><span id="semana-val-liquido">‚Ç¨ 0,00</span>
        </div>
        <div class="resumo-line" style="background:#333;">
          <span>Dist√¢ncia Total:</span><span id="semana-val-km">0 km</span>
        </div>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:14px;">Detalhamento de Ganhos</div>
        <table class="table-container">
          <thead><tr><th>Dia</th><th>Uber</th><th>Bolt</th><th>Total</th></tr></thead>
          <tbody id="semana-tabela-corpo"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="section-title" style="font-size:14px;">Custos Detalhados</div>
        <div id="semana-lista-custos"></div>
        <div class="resumo-line" style="background:#111; border:1px solid #444; margin-top:10px; font-weight:bold;">
            <span>Total de Custos:</span><span id="semana-val-total-custos" style="color:#ff6b6b;">‚Ç¨ 0,00</span>
        </div>
      </div>
    </section>

    <section id="tab-mes" class="tab-content">
      <div class="nav-data-container">
        <span class="nav-arrow" onclick="mudarMes(-1)">&#10094;</span>
        <div id="label-mes" class="section-date"></div>
        <span class="nav-arrow" id="seta-mes-next" onclick="mudarMes(1)">&#10095;</span>
      </div>
      <button class="btn-excel" onclick="baixarRelatorioCompleto()">üì• BAIXAR RELAT√ìRIO EXCEL</button>
      <div class="card">
        <div class="section-title">Fechamento do M√™s</div>
        <table class="table-container">
          <thead><tr><th>Categoria</th><th>Entradas</th><th>Sa√≠da</th><th>Sa√≠da (Re.)</th></tr></thead>
          <tbody id="mes-tabela-corpo"></tbody>
          <tfoot>
            <tr style="background:#111; font-weight:bold; font-size:13px;">
              <td>SALDO FINAL</td>
              <td colspan="3" id="mes-saldo-final" style="color:#00bf63;">‚Ç¨ 0,00</td>
            </tr>
          </tfoot>
        </table>
      </div>
      <div id="card-detalhes-outros" class="card" style="display:none;">
        <div class="section-title">Outros</div>
        <table class="table-container">
          <thead><tr><th>Dia</th><th>Descri√ß√£o</th><th>Sa√≠da</th><th>Sa√≠da (Re.)</th></tr></thead>
          <tbody id="tabela-outros-corpo"></tbody>
        </table>
      </div>
    </section>

    <nav class="dock-container">
      <div class="dock-item active" onclick="switchTab('dia', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
        <span>Dia</span>
      </div>
      <div class="dock-item" onclick="switchTab('semana', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20v-6M6 20V10M18 20V4"></path></svg>
        <span>Semana</span>
      </div>
      <div class="dock-item" onclick="switchTab('mes', this)">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>
        <span>M√™s</span>
      </div>
    </nav>
  </div>

  <div id="modal-geral" class="modal">
    <div class="modal-content">
      <h3 id="modal-titulo" style="margin-bottom:15px; font-size:16px; color:#00bf63;"></h3>
      <div id="modal-body"></div>
      <div style="display:flex; justify-content:flex-end; gap:10px;">
        <button onclick="fecharModal()" style="padding:10px; background:#444; border:none; border-radius:5px; color:#fff;">Cancelar</button>
        <button id="btn-confirmar" style="padding:10px; background:#00bf63; border:none; border-radius:5px; color:#fff;">Confirmar</button>
      </div>
    </div>
  </div>

  <script>
    let dataRef = new Date(); dataRef.setHours(0,0,0,0);
    const HOJE = new Date(); HOJE.setHours(0,0,0,0);
    let abaAtual = 'dia';
    let tempReembolso = 'N√£o';

    function n(v) { let num = parseFloat(v); return isNaN(num) ? 0 : num; }
    function f(v) { return n(v).toLocaleString('pt-PT', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

    function getPeriodoSemana(data) {
      const d = new Date(data);
      const day = d.getDay();
      const diff = d.getDate() - (day === 0 ? 6 : day - 1);
      const segunda = new Date(d.setDate(diff));
      segunda.setHours(0,0,0,0);
      const domingo = new Date(segunda); 
      domingo.setDate(segunda.getDate() + 6);
      return { segunda, domingo };
    }

    function switchTab(aba, el) {
      abaAtual = aba;
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.dock-item').forEach(i => i.classList.remove('active'));
      document.getElementById('tab-' + aba).classList.add('active');
      el.classList.add('active');
      render();
    }

    function mudarData(d) { dataRef.setDate(dataRef.getDate() + d); render(); }
    function mudarMes(m) { dataRef.setMonth(dataRef.getMonth() + m); render(); }

    function render() {
      if(abaAtual === 'dia') renderDia();
      if(abaAtual === 'semana') renderSemana();
      if(abaAtual === 'mes') renderMes();
    }

    function renderDia() {
      const key = "mytvde_" + dataRef.toISOString().split('T')[0];
      const s = JSON.parse(localStorage.getItem(key)) || { uber: null, bolt: null, despesas: [], kmInicio: "", kmFim: "" };
      document.getElementById('label-dia').innerText = dataRef.toLocaleDateString('pt-BR', {day:'numeric', month:'long', year:'numeric'});
      document.getElementById('dia-total-bruto').innerText = `‚Ç¨ ${f(n(s.uber) + n(s.bolt))}`;
      document.getElementById('uber-slot').innerHTML = renderBtnPlat('uber', s.uber);
      document.getElementById('bolt-slot').innerHTML = renderBtnPlat('bolt', s.bolt);
      const lista = document.getElementById('lista-despesas-dia');
      lista.innerHTML = (s.despesas && s.despesas.length) ? "" : "<p style='color:#666; font-size:11px;'>Sem despesas.</p>";
      if(s.despesas) {
        s.despesas.forEach((d, i) => {
          const icone = d.reembolso === 'Sim' ? '‚Ü© ' : '';
          lista.innerHTML += `<div class="resumo-line" style="background:#222; margin-bottom:4px; padding:6px 10px;">
            <span style="font-size:11px;">${icone}${d.cat}: ‚Ç¨ ${f(d.val)}</span>
            <span style="color:#ff6b6b; cursor:pointer;" onclick="deletarDespesa(${i})">X</span>
          </div>`;
        });
      }
      document.getElementById('km-inicio').value = s.kmInicio || "";
      document.getElementById('km-fim').value = s.kmFim || "";
      document.getElementById('km-total-dia').innerText = Math.max(0, n(s.kmFim) - n(s.kmInicio)) + " km";
    }

    function renderBtnPlat(p, v) {
      if(v === null || v === "") return `<button class="km-input" style="background:#fff; color:#000; font-weight:bold;" onclick="abrirModalRendimento('${p}')">${p.toUpperCase()}</button>`;
      return `<div class="resumo-line" style="background:#111; border:1px solid #333; margin:0;" onclick="abrirModalRendimento('${p}')"><span>${p.toUpperCase()}</span><span>‚Ç¨ ${f(v)}</span></div>`;
    }

    function renderSemana() {
      const { segunda, domingo } = getPeriodoSemana(dataRef);
      document.getElementById('label-semana').innerText = `${segunda.getDate()} ${segunda.toLocaleString('pt-BR',{month:'short'})} - ${domingo.getDate()} ${domingo.toLocaleString('pt-BR',{month:'short'})}`;
      let tU = 0, tB = 0, tK = 0, tRe = 0, tGeral = 0;
      let custos = { "Combust√≠vel": 0, "Comida": 0, "Administrativo": 0, "Outros": 0 };
      let html = "";

      for(let i=0; i<7; i++) {
        let d = new Date(segunda); d.setDate(segunda.getDate() + i);
        let s = JSON.parse(localStorage.getItem("mytvde_" + d.toISOString().split('T')[0])) || {uber:0, bolt:0, despesas:[]};
        tU += n(s.uber); tB += n(s.bolt);
        tK += Math.max(0, n(s.kmFim) - n(s.kmInicio));
        if(s.despesas) {
          s.despesas.forEach(dp => {
            let v = n(dp.val);
            if(custos[dp.cat] !== undefined) custos[dp.cat] += v; else custos["Outros"] += v;
            tGeral += v; if(dp.reembolso === 'Sim') tRe += v;
          });
        }
        html += `<tr><td>${d.getDate()}</td><td>${f(n(s.uber))}</td><td>${f(n(s.bolt))}</td><td>${f(n(s.uber)+n(s.bolt))}</td></tr>`;
      }
      const valVV = n(localStorage.getItem("vv_" + segunda.toISOString().split('T')[0]));
      const bruto = tU + tB;
      const taxa = bruto * 0.08;
      
      document.getElementById('semana-vv-status').innerText = valVV > 0 ? `Via Verde: ‚Ç¨ ${f(valVV)}` : "‚ùå Via Verde";
      document.getElementById('semana-tabela-corpo').innerHTML = html + `<tr style="font-weight:bold; background:#111;"><td>TOT</td><td>${f(tU)}</td><td>${f(tB)}</td><td style="color:#00bf63">${f(bruto)}</td></tr>`;
      document.getElementById('semana-val-liquido').innerText = `‚Ç¨ ${f(bruto - (taxa + valVV + tRe))}`;
      document.getElementById('semana-val-km').innerText = tK + " km";
      document.getElementById('semana-val-total-custos').innerText = `‚Ç¨ ${f(taxa + valVV + tGeral)}`;

      let hC = `<div class="resumo-line" style="background:#ff6b6b; color:#000;"><span>Taxa Plataforma (8%)</span><span>‚Ç¨ ${f(taxa)}</span></div>`;
      if(valVV > 0) hC += `<div class="resumo-line" style="background:#4da3ff; color:#000;"><span>Via Verde</span><span>‚Ç¨ ${f(valVV)}</span></div>`;
      const cores = { "Combust√≠vel": "#ffd93d", "Comida": "#ff8000", "Administrativo": "#a288e3", "Outros": "#888" };
      for(let c in custos) if(custos[c] > 0) hC += `<div class="resumo-line" style="background:${cores[c]}; color:#000;"><span>${c}</span><span>‚Ç¨ ${f(custos[c])}</span></div>`;
      document.getElementById('semana-lista-custos').innerHTML = hC;
    }

    function renderMes() {
      document.getElementById('label-mes').innerText = dataRef.toLocaleString('pt-BR', {month:'long', year:'numeric'}).toUpperCase();
      let entBruto = 0, totalVV = 0, totalTaxas = 0;
      let cats = { Combust√≠vel: {sim:0, nao:0}, Comida: {sim:0, nao:0}, Administrativo: {sim:0, nao:0}, Outros: {sim:0, nao:0} };
      let listaOutros = [];

      let d = new Date(dataRef.getFullYear(), dataRef.getMonth(), 1);
      while(d.getMonth() === dataRef.getMonth()) {
        let s = JSON.parse(localStorage.getItem("mytvde_" + d.toISOString().split('T')[0])) || {uber:0, bolt:0, despesas:[]};
        let b = n(s.uber) + n(s.bolt);
        entBruto += b; totalTaxas += b * 0.08;
        if(s.despesas) {
          s.despesas.forEach(dp => {
            let v = n(dp.val);
            let c = (dp.cat === "Combust√≠vel" || dp.cat === "Comida" || dp.cat === "Administrativo") ? dp.cat : "Outros";
            if(dp.reembolso === 'Sim') cats[c].sim += v; else cats[c].nao += v;
            if(c === "Outros") listaOutros.push({ dia: d.getDate(), desc: dp.cat, valor: v, re: dp.reembolso });
          });
        }
        d.setDate(d.getDate() + 1);
      }
      for(let k in localStorage) if(k.startsWith("vv_") && k.includes(dataRef.toISOString().slice(0,7))) totalVV += n(localStorage.getItem(k));

      let h = `<tr><td>Rend. Brutos</td><td style="color:#00bf63">+ ‚Ç¨ ${f(entBruto)}</td><td>-</td><td>-</td></tr>`;
      h += `<tr><td>Taxas (8%)</td><td>-</td><td>-</td><td style="color:#ff6b6b">‚Ç¨ ${f(totalTaxas)}</td></tr>`;
      if(totalVV > 0) h += `<tr><td>Via Verde</td><td>-</td><td>-</td><td style="color:#ff6b6b">‚Ç¨ ${f(totalVV)}</td></tr>`;

      let somaTudo = totalTaxas + totalVV;
      for(let c in cats) {
        if(cats[c].sim > 0 || cats[c].nao > 0) {
          h += `<tr><td>${c}</td><td>-</td><td style="color:#ff6b6b">${cats[c].nao>0?'‚Ç¨ '+f(cats[c].nao):'-'}</td><td style="color:#ff6b6b">${cats[c].sim>0?'‚Ç¨ '+f(cats[c].sim):'-'}</td></tr>`;
          somaTudo += (cats[c].sim + cats[c].nao);
        }
      }
      document.getElementById('mes-tabela-corpo').innerHTML = h;
      document.getElementById('mes-saldo-final').innerText = `‚Ç¨ ${f(entBruto - somaTudo)}`;

      const cardO = document.getElementById('card-detalhes-outros');
      if(listaOutros.length > 0) {
        cardO.style.display = "block";
        document.getElementById('tabela-outros-corpo').innerHTML = listaOutros.map(i => 
          `<tr><td>${i.dia}</td><td>${i.desc}</td><td style="color:#ff6b6b">${i.re==='N√£o'?'‚Ç¨ '+f(i.valor):'-'}</td><td style="color:#ff6b6b">${i.re==='Sim'?'‚Ç¨ '+f(i.valor):'-'}</td></tr>`
        ).join('');
      } else cardO.style.display = "none";
    }

    // FUN√á√ïES DE APOIO
    function abrirModalDespesa() {
      tempReembolso = 'N√£o';
      document.getElementById('modal-titulo').innerText = "Nova Despesa";
      document.getElementById('modal-body').innerHTML = `
        <select id="cat-d" class="modal-select" onchange="document.getElementById('out-d').style.display=(this.value=='Outros'?'block':'none')">
          <option value="Combust√≠vel">Combust√≠vel</option><option value="Comida">Comida</option><option value="Administrativo">Administrativo</option><option value="Outros">Outro (Digitar)</option>
        </select>
        <input type="text" id="out-d" class="modal-input" style="display:none;" placeholder="Qual despesa?">
        <input type="number" id="val-d" class="modal-input" placeholder="0.00">
        <div class="reembolso-container"><div id="reemb-sim" class="reembolso-btn" onclick="setReembolso('Sim')">Sim</div><div id="reemb-nao" class="reembolso-btn active" onclick="setReembolso('N√£o')">N√£o</div></div>`;
      document.getElementById('modal-geral').style.display = "flex";
      document.getElementById('btn-confirmar').onclick = () => {
        let c = document.getElementById('cat-d').value; if(c=='Outros') c=document.getElementById('out-d').value||"Outros";
        let v = n(document.getElementById('val-d').value); if(v<=0) return;
        let key = "mytvde_" + dataRef.toISOString().split('T')[0];
        let s = JSON.parse(localStorage.getItem(key)) || { uber:null, bolt:null, despesas:[], kmInicio:"", kmFim:"" };
        s.despesas.push({ cat: c, val: v, reembolso: tempReembolso });
        localStorage.setItem(key, JSON.stringify(s)); fecharModal(); render();
      };
    }

    function setReembolso(v) { tempReembolso=v; document.getElementById('reemb-sim').classList.toggle('active', v==='Sim'); document.getElementById('reemb-nao').classList.toggle('active', v==='N√£o'); }
    function salvarDadosDia() {
      let key = "mytvde_" + dataRef.toISOString().split('T')[0];
      let s = JSON.parse(localStorage.getItem(key)) || { uber:null, bolt:null, despesas:[], kmInicio:"", kmFim:"" };
      s.kmInicio = document.getElementById('km-inicio').value; s.kmFim = document.getElementById('km-fim').value;
      localStorage.setItem(key, JSON.stringify(s)); render();
    }

    function abrirModalRendimento(p) {
      document.getElementById('modal-titulo').innerText = "Rendimento " + p.toUpperCase();
      document.getElementById('modal-body').innerHTML = `<input type="number" id="val-p" class="modal-input" placeholder="0.00">`;
      document.getElementById('modal-geral').style.display = "flex";
      document.getElementById('btn-confirmar').onclick = () => {
        let v = document.getElementById('val-p').value;
        let key = "mytvde_" + dataRef.toISOString().split('T')[0];
        let s = JSON.parse(localStorage.getItem(key)) || { uber:null, bolt:null, despesas:[], kmInicio:"", kmFim:"" };
        s[p] = v === "" ? null : v;
        localStorage.setItem(key, JSON.stringify(s)); fecharModal(); render();
      };
    }

    function deletarDespesa(i) {
      let key = "mytvde_" + dataRef.toISOString().split('T')[0];
      let s = JSON.parse(localStorage.getItem(key)); s.despesas.splice(i, 1);
      localStorage.setItem(key, JSON.stringify(s)); render();
    }

    function abrirModalVV() {
      const { segunda } = getPeriodoSemana(dataRef);
      const key = "vv_" + segunda.toISOString().split('T')[0];
      document.getElementById('modal-titulo').innerText = "Via Verde Semanal";
      document.getElementById('modal-body').innerHTML = `<input type="number" id="val-vv" class="modal-input" value="${localStorage.getItem(key)||''}">`;
      document.getElementById('modal-geral').style.display = "flex";
      document.getElementById('btn-confirmar').onclick = () => { localStorage.setItem(key, document.getElementById('val-vv').value); fecharModal(); render(); };
    }

    function fecharModal() { document.getElementById('modal-geral').style.display = "none"; }

    // ====== FUN√á√ÉO EXCEL CORRIGIDA (LAYOUT SEMANAL SEPARADO) ======
    function baixarRelatorioCompleto() {
        let wb = XLSX.utils.book_new();
        let rows = [];

        // Identifica as semanas que cobrem o m√™s selecionado
        let year = dataRef.getFullYear();
        let month = dataRef.getMonth();
        // Inicia na segunda-feira que engloba o dia 1 do m√™s (ou um pouco antes)
        let firstDay = new Date(year, month, 1);
        let startOfWeek = new Date(firstDay);
        let dayOfWeek = startOfWeek.getDay(); // 0=Sun, 1=Mon...
        // Ajuste para pegar a segunda-feira da semana
        let diff = startOfWeek.getDate() - dayOfWeek + (dayOfWeek == 0 ? -6 : 1);
        startOfWeek.setDate(diff);

        // Ultimo dia do mes
        let lastDay = new Date(year, month + 1, 0);

        // Loop por semanas at√© cobrir todo o m√™s
        while (startOfWeek <= lastDay) {
            let endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);

            // 1. Calcular Dados da Semana
            let tUber=0, tBolt=0, tDespTotal=0, tDespRe=0;
            let weekData = [];
            
            // Loop 7 dias da semana
            for(let i=0; i<7; i++) {
                let d = new Date(startOfWeek);
                d.setDate(startOfWeek.getDate() + i);
                let key = "mytvde_" + d.toISOString().split('T')[0];
                let s = JSON.parse(localStorage.getItem(key)) || {uber:0, bolt:0, despesas:[]};
                
                let u = n(s.uber); let b = n(s.bolt);
                tUber += u; tBolt += b;
                if(s.despesas) s.despesas.forEach(dp => {
                   let v = n(dp.val); tDespTotal += v;
                   if(dp.reembolso === 'Sim') tDespRe += v;
                });

                weekData.push({
                   dStr: d.toLocaleDateString('pt-PT', {weekday: 'long', day: 'numeric', month:'numeric'}),
                   u: u, b: b, t: u+b
                });
            }

            // Via Verde da semana (busca pela segunda-feira)
            let vvKey = "vv_" + startOfWeek.toISOString().split('T')[0];
            let valVV = n(localStorage.getItem(vvKey));

            let tBruto = tUber + tBolt;
            let tTaxas = tBruto * 0.08;
            let tLiq = tBruto - (tTaxas + valVV + tDespRe);

            // 2. Montar Bloco Visual (Excel)
            rows.push([`RELAT√ìRIO SEMANAL: ${startOfWeek.toLocaleDateString('pt-PT')} a ${endOfWeek.toLocaleDateString('pt-PT')}`]);
            // Cabe√ßalho das colunas (com espa√ßo vazio na E)
            rows.push(["DIA", "UBER", "BOLT", "TOTAL", "", "RESUMO", "VALOR"]);

            // Dados laterais fixos (7 linhas para casar com os 7 dias)
            let resumoMap = [
                {k: "Uber Bruto", v: tUber},
                {k: "Bolt Bruto", v: tBolt},
                {k: "TOTAL BRUTO", v: tBruto},
                {k: "Taxas (8%)", v: tTaxas},
                {k: "Via Verde", v: valVV},
                {k: "Despesas", v: tDespTotal},
                {k: "L√çQUIDO FINAL", v: tLiq}
            ];

            // Preencher as 7 linhas
            for(let i=0; i<7; i++) {
                let wd = weekData[i];
                let rm = resumoMap[i];
                rows.push([
                    wd.dStr, 
                    wd.u, 
                    wd.b, 
                    wd.t, 
                    "",        // Coluna E vazia
                    rm.k,      // Coluna F (Resumo)
                    rm.v       // Coluna G (Valor)
                ]);
            }

            // Pular linhas antes da pr√≥xima semana
            rows.push([]); 
            rows.push([]);

            // Avan√ßar para pr√≥xima semana
            startOfWeek.setDate(startOfWeek.getDate() + 7);
        }

        let ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "Relatorio Semanal");
        XLSX.writeFile(wb, `Relatorio_${dataRef.getMonth()+1}_${dataRef.getFullYear()}.xlsx`);
    }

    render();
  </script>
</body>
</html>
